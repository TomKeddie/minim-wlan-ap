From 730d61df6bfc31a570c9a9cc322d8e749f3f5853 Mon Sep 17 00:00:00 2001
From: John Crispin <john@phrozen.org>
Date: Mon, 5 Dec 2022 11:51:03 +0100
Subject: [PATCH] ipq807x: integrate qsdk v5.4 kernel

Signed-off-by: John Crispin <john@phrozen.org>
---
 config/Config-images.in           | 2 ++
 include/kernel.mk                 | 5 +++--
 include/quilt.mk                  | 4 ++++
 include/target.mk                 | 8 +++++++-
 toolchain/gcc/Config.in           | 8 ++++++++
 toolchain/gcc/Config.version      | 2 ++
 toolchain/kernel-headers/Makefile | 2 +-
 7 files changed, 27 insertions(+), 4 deletions(-)

diff --git a/config/Config-images.in b/config/Config-images.in
index 2921cd5bca..d50001ddcf 100644
--- a/config/Config-images.in
+++ b/config/Config-images.in
@@ -17,6 +17,8 @@ menu "Target Images"
 			default TARGET_INITRAMFS_COMPRESSION_LZMA if TARGET_lantiq
 			default TARGET_INITRAMFS_COMPRESSION_LZMA if TARGET_mpc85xx
 			default TARGET_INITRAMFS_COMPRESSION_LZMA if TARGET_ramips
+			default TARGET_INITRAMFS_COMPRESSION_GZIP if TARGET_ipq807x
+			default TARGET_INITRAMFS_COMPRESSION_GZIP if TARGET_ipq60xx
 			default TARGET_INITRAMFS_COMPRESSION_NONE
 			depends on TARGET_ROOTFS_INITRAMFS
 			help
diff --git a/include/kernel.mk b/include/kernel.mk
index e4074a48f4..f15c64dc4a 100644
--- a/include/kernel.mk
+++ b/include/kernel.mk
@@ -44,7 +44,7 @@ else
     FILES_DIR ?= $(foreach dir,$(wildcard $(CURDIR)/files $(CURDIR)/files-$(KERNEL_PATCHVER)),"$(dir)")
   endif
   KERNEL_BUILD_DIR ?= $(BUILD_DIR)/linux-$(BOARD)$(if $(SUBTARGET),_$(SUBTARGET))
-  LINUX_DIR ?= $(KERNEL_BUILD_DIR)/linux-$(LINUX_VERSION)
+  LINUX_DIR ?= $(KERNEL_BUILD_DIR)/linux-$(LINUX_VERSION)$(KERNEL_NAME_SUFFIX)
   LINUX_UAPI_DIR=uapi/
   LINUX_VERMAGIC:=$(strip $(shell cat $(LINUX_DIR)/.vermagic 2>/dev/null))
   LINUX_VERMAGIC:=$(if $(LINUX_VERMAGIC),$(LINUX_VERMAGIC),unknown)
@@ -59,7 +59,7 @@ else
   ifneq (,$(findstring -rc,$(LINUX_VERSION)))
       LINUX_SOURCE:=linux-$(LINUX_VERSION).tar.gz
   else
-      LINUX_SOURCE:=linux-$(LINUX_VERSION).tar.xz
+      LINUX_SOURCE:=linux-$(LINUX_VERSION)$(KERNEL_NAME_SUFFIX).tar.xz
   endif
 
   ifneq (,$(findstring -rc,$(LINUX_VERSION)))
@@ -100,6 +100,7 @@ endif
 
 KERNEL_MAKE = $(MAKE) $(KERNEL_MAKEOPTS)
 
+
 KERNEL_MAKE_FLAGS = \
 	KCFLAGS="$(call iremap,$(BUILD_DIR),$(notdir $(BUILD_DIR)))" \
 	HOSTCFLAGS="$(HOST_CFLAGS) -Wall -Wmissing-prototypes -Wstrict-prototypes" \
diff --git a/include/quilt.mk b/include/quilt.mk
index 00597ca0f2..e78de2e884 100644
--- a/include/quilt.mk
+++ b/include/quilt.mk
@@ -99,9 +99,11 @@ define Kernel/Patch/Default
 		echo "generic patches directory is present. please move your patches to the pending directory" ; \
 		exit 1; \
 	fi
+ifneq ($(CONFIG_TARGET_ipq807x)$(CONFIG_TARGET_ipq60xx),y)
 	$(call PatchDir,$(LINUX_DIR),$(GENERIC_BACKPORT_DIR),generic-backport/)
 	$(call PatchDir,$(LINUX_DIR),$(GENERIC_PATCH_DIR),generic/)
 	$(call PatchDir,$(LINUX_DIR),$(GENERIC_HACK_DIR),generic-hack/)
+endif
 	$(call PatchDir,$(LINUX_DIR),$(PATCH_DIR),platform/)
 endef
 
@@ -128,9 +130,11 @@ define Quilt/Refresh/Kernel
 		echo "All kernel patches must start with either generic/ or platform/"; \
 		false; \
 	}
+ifneq ($(CONFIG_TARGET_ipq807x)$(CONFIG_TARGET_ipq60xx,y)
 	$(call Quilt/RefreshDir,$(PKG_BUILD_DIR),$(GENERIC_BACKPORT_DIR),generic-backport/)
 	$(call Quilt/RefreshDir,$(PKG_BUILD_DIR),$(GENERIC_PATCH_DIR),generic/)
 	$(call Quilt/RefreshDir,$(PKG_BUILD_DIR),$(GENERIC_HACK_DIR),generic-hack/)
+endif
 	$(call Quilt/RefreshDir,$(PKG_BUILD_DIR),$(PATCH_DIR),platform/)
 endef
 
diff --git a/include/target.mk b/include/target.mk
index 7526224972..1e17f77589 100644
--- a/include/target.mk
+++ b/include/target.mk
@@ -138,11 +138,17 @@ ifneq ($(TARGET_BUILD)$(if $(DUMP),,1),)
 endif
 
 GENERIC_PLATFORM_DIR := $(TOPDIR)/target/linux/generic
+ifeq ($(CONFIG_TARGET_ipq807x)$(CONFIG_TARGET_ipq60xx),y)
+GENERIC_BACKPORT_DIR :=
+GENERIC_PATCH_DIR :=
+GENERIC_HACK_DIR :=
+GENERIC_FILES_DIR :=
+else
 GENERIC_BACKPORT_DIR := $(GENERIC_PLATFORM_DIR)/backport$(if $(wildcard $(GENERIC_PLATFORM_DIR)/backport-$(KERNEL_PATCHVER)),-$(KERNEL_PATCHVER))
 GENERIC_PATCH_DIR := $(GENERIC_PLATFORM_DIR)/pending$(if $(wildcard $(GENERIC_PLATFORM_DIR)/pending-$(KERNEL_PATCHVER)),-$(KERNEL_PATCHVER))
 GENERIC_HACK_DIR := $(GENERIC_PLATFORM_DIR)/hack$(if $(wildcard $(GENERIC_PLATFORM_DIR)/hack-$(KERNEL_PATCHVER)),-$(KERNEL_PATCHVER))
 GENERIC_FILES_DIR := $(foreach dir,$(wildcard $(GENERIC_PLATFORM_DIR)/files $(GENERIC_PLATFORM_DIR)/files-$(KERNEL_PATCHVER)),"$(dir)")
-
+endif
 __config_name_list = $(1)/config-$(KERNEL_PATCHVER) $(1)/config-default
 __config_list = $(firstword $(wildcard $(call __config_name_list,$(1))))
 find_kernel_config=$(if $(__config_list),$(__config_list),$(lastword $(__config_name_list)))
diff --git a/toolchain/gcc/Config.in b/toolchain/gcc/Config.in
index f0fc31d567..bd0d072d9b 100644
--- a/toolchain/gcc/Config.in
+++ b/toolchain/gcc/Config.in
@@ -3,6 +3,8 @@
 choice
 	prompt "GCC compiler Version" if TOOLCHAINOPTS
 	default GCC_USE_VERSION_8
+	default GCC_USE_VERSION_7 if TARGET_ipq807x
+	default GCC_USE_VERSION_7 if TARGET_ipq60xx
 	help
 	  Select the version of gcc you wish to use.
 
@@ -12,12 +14,18 @@ choice
 
 	config GCC_USE_VERSION_8
 		bool "gcc 8.x"
+		depends on !TARGET_ipq807x
+		depends on !TARGET_ipq60xx
 
 	config GCC_USE_VERSION_9
 		bool "gcc 9.x"
+		depends on !TARGET_ipq807x
+		depends on !TARGET_ipq60xx
 
 	config GCC_USE_VERSION_10
 		bool "gcc 10.x"
+		depends on !TARGET_ipq807x
+		depends on !TARGET_ipq60xx
 endchoice
 
 config GCC_USE_GRAPHITE
diff --git a/toolchain/gcc/Config.version b/toolchain/gcc/Config.version
index 967ce9e489..5355de17fb 100644
--- a/toolchain/gcc/Config.version
+++ b/toolchain/gcc/Config.version
@@ -1,5 +1,7 @@
 config GCC_VERSION_7
 	default y if GCC_USE_VERSION_7
+	default y if TARGET_ipq807x
+	default y if TARGET_ipq60xx
 	bool
 
 config GCC_VERSION_9
diff --git a/toolchain/kernel-headers/Makefile b/toolchain/kernel-headers/Makefile
index eea0ffbde0..c33f26d46d 100644
--- a/toolchain/kernel-headers/Makefile
+++ b/toolchain/kernel-headers/Makefile
@@ -32,7 +32,7 @@ else
   PKG_SOURCE:=$(LINUX_SOURCE)
   PKG_SOURCE_URL:=$(LINUX_SITE)
 endif
-HOST_BUILD_DIR:=$(KERNEL_BUILD_DIR)/linux-$(LINUX_VERSION)
+HOST_BUILD_DIR:=$(KERNEL_BUILD_DIR)/linux-$(LINUX_VERSION)$(KERNEL_NAME_SUFFIX)
 PKG_HASH:=$(LINUX_KERNEL_HASH)
 LINUX_DIR := $(HOST_BUILD_DIR)
 FILES_DIR := 
-- 
2.25.1

