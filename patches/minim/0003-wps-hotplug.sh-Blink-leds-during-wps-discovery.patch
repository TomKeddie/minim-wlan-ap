From 9462e7b3ff37ac5deefc57a31167d8854e1b46d5 Mon Sep 17 00:00:00 2001
From: Brett Mastbergen <brettm@minim.com>
Date: Wed, 16 Nov 2022 11:18:16 -0500
Subject: [PATCH] wps-hotplug.sh: Blink leds during wps discovery

SW-2701
---
 .../services/hostapd/files/wps-hotplug.sh     | 29 +++++++++++++++++++
 1 file changed, 29 insertions(+)

diff --git a/package/network/services/hostapd/files/wps-hotplug.sh b/package/network/services/hostapd/files/wps-hotplug.sh
index 073bdd1868..8555dc6632 100644
--- a/package/network/services/hostapd/files/wps-hotplug.sh
+++ b/package/network/services/hostapd/files/wps-hotplug.sh
@@ -1,5 +1,33 @@
 #!/bin/sh
 
+wps_flash_leds() {
+	local ubusobjs=$1
+	local finished=0
+
+	STATE=$(/sbin/leds.sh led_get_state)
+
+	/sbin/leds.sh led_wps
+
+	. /usr/share/libubox/jshn.sh
+	while [ $finished -eq 0 ]; do
+		for ubusobj in $ubusobjs; do
+			json_init
+			json_load "$(ubus -S call $ubusobj wps_status)"
+			json_get_vars pbc_status
+			[ "$pbc_status" = "Timed-out" -o "$pbc_status" = "Disabled" ] && {
+				finished=1
+			}
+		done
+		sleep 1
+	done
+
+	if [ "$STATE" = "led_off" ] ; then
+		/sbin/leds.sh led_wlan_off
+	else
+		/sbin/leds.sh led_wlan
+	fi
+}
+
 wps_catch_credentials() {
 	local iface ifaces ifc ifname ssid encryption key radio radios
 	local found=0
@@ -50,6 +78,7 @@ if [ "$ACTION" = "released" ] && [ "$BUTTON" = "wps" ]; then
 		for ubusobj in $ubusobjs; do
 			ubus -S call $ubusobj wps_start && wps_done=1
 		done
+		wps_flash_leds "$ubusobjs" &
 		[ $wps_done = 0 ] || return 0
 	fi
 	wps_done=0
-- 
2.30.2

